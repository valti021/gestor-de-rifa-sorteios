<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Recorte por Arraste</title>
    <style>
        body {
    font-family: Arial, sans-serif;
    background: #eee;
}

.container {
    max-width: 420px;
    background: #fff;
    margin: 40px auto;
    padding: 20px;
    border-radius: 8px;
}

select, button {
    width: 100%;
    padding: 10px;
    margin-top: 12px;
}

.hidden {
    display: none;
}

/* Área de recorte */
.crop-area {
    position: relative;
    width: 300px;
    height: 300px;
    margin: 20px auto;
    overflow: hidden;
    border-radius: 6px;
}

canvas {
    cursor: grab;
}

canvas:active {
    cursor: grabbing;
}

/* Moldura fixa 1:1 */
.crop-overlay {
    position: absolute;
    inset: 0;
    border: 2px dashed #fff;
    box-shadow: 0 0 0 9999px rgba(0,0,0,0.5);
    pointer-events: none;
}

/* Ações */
.acoes {
    display: flex;
    gap: 10px;
}

/* Previews */
#listaPreviews {
    display: flex;
    gap: 10px;
    margin-top: 20px;
}

.preview {
    position: relative;
    width: 70px;
    height: 70px;
}

.preview img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 4px;
}

.preview span {
    position: absolute;
    top: -5px;
    right: -5px;
    background: #000;
    color: #fff;
    width: 20px;
    height: 20px;
    font-size: 12px;
    border-radius: 50%;
    text-align: center;
    line-height: 20px;
}

    </style>
</head>
<body>

<div class="container">
    <h2>Você deseja importar quantas imagens?</h2>

    <select id="quantidade">
        <option value="">Selecione</option>
        <option value="1">1 imagem</option>
        <option value="2">2 imagens</option>
    </select>

    <input type="file" id="inputImagem" accept="image/*" hidden>

    <button id="btnAdicionar" class="hidden">Adicionar imagem</button>

    <!-- RECORTE -->
    <div id="recorteContainer" class="hidden">
        <div class="crop-area">
            <canvas id="canvas"></canvas>
            <div class="crop-overlay"></div>
        </div>

        <div class="acoes">
            <button id="confirmar">OK</button>
            <button id="cancelar">Cancelar</button>
        </div>
    </div>

    <div id="listaPreviews"></div>
</div>

<script>
const select = document.getElementById("quantidade");
const input = document.getElementById("inputImagem");
const btnAdd = document.getElementById("btnAdicionar");
const recorte = document.getElementById("recorteContainer");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

const confirmar = document.getElementById("confirmar");
const cancelar = document.getElementById("cancelar");
const previews = document.getElementById("listaPreviews");

canvas.width = 300;
canvas.height = 300;

let max = 0;
let imagens = [];

let img = new Image();
let posX = 0;
let posY = 0;
let startX, startY;
let dragging = false;
let scale = 1;

/* Quantidade */
select.addEventListener("change", () => {
    max = Number(select.value);
    imagens = [];
    previews.innerHTML = "";
    btnAdd.classList.remove("hidden");
});

/* Abrir seletor */
btnAdd.addEventListener("click", () => {
    if (imagens.length >= max) {
        alert("Limite atingido");
        return;
    }
    input.click();
});

/* Carregar imagem */
input.addEventListener("change", e => {
    const file = e.target.files[0];
    if (!file) return;

    img.onload = () => {
        scale = Math.max(
            canvas.width / img.width,
            canvas.height / img.height
        );

        posX = (canvas.width - img.width * scale) / 2;
        posY = (canvas.height - img.height * scale) / 2;

        desenhar();
        recorte.classList.remove("hidden");
    };

    img.src = URL.createObjectURL(file);
});

/* Desenhar imagem */
function desenhar() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(
        img,
        posX,
        posY,
        img.width * scale,
        img.height * scale
    );
}

/* Arrastar */
canvas.addEventListener("mousedown", e => {
    dragging = true;
    startX = e.offsetX - posX;
    startY = e.offsetY - posY;
});

canvas.addEventListener("mousemove", e => {
    if (!dragging) return;

    posX = e.offsetX - startX;
    posY = e.offsetY - startY;
    desenhar();
});

canvas.addEventListener("mouseup", () => dragging = false);
canvas.addEventListener("mouseleave", () => dragging = false);

/* Confirmar */
confirmar.addEventListener("click", () => {
    const exportCanvas = document.createElement("canvas");
    exportCanvas.width = 1080;
    exportCanvas.height = 1080;
    const ectx = exportCanvas.getContext("2d");

    ectx.drawImage(
        img,
        (-posX / scale),
        (-posY / scale),
        canvas.width / scale,
        canvas.height / scale,
        0,
        0,
        1080,
        1080
    );

    const data = exportCanvas.toDataURL("image/jpeg");
    imagens.push(data);

    criarPreview(data, imagens.length);
    recorte.classList.add("hidden");
    input.value = "";

    if (imagens.length >= max) {
        btnAdd.classList.add("hidden");
    }
});

/* Cancelar */
cancelar.addEventListener("click", () => {
    recorte.classList.add("hidden");
    input.value = "";
});

/* Preview */
function criarPreview(src, index) {
    const div = document.createElement("div");
    div.className = "preview";

    const img = document.createElement("img");
    img.src = src;

    const num = document.createElement("span");
    num.textContent = index;

    div.appendChild(img);
    div.appendChild(num);
    previews.appendChild(div);
}

</script>
</body>
</html>
